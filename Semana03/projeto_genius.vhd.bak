LIBRARY ieee;
USE ieee.std_logic_1164.ALL;
USE ieee.numeric_std.ALL;
USE ieee.math_real.ALL;

ENTITY projeto_genius IS
    PORT (
        clock : IN STD_LOGIC;
        reset : IN STD_LOGIC;
        iniciar : IN STD_LOGIC;
        modo1 : IN STD_LOGIC;
        modo2e3 : IN STD_LOGIC;
        botoes : IN STD_LOGIC_VECTOR (5 DOWNTO 0);
        leds : OUT STD_LOGIC_VECTOR (5 DOWNTO 0);
        pronto : OUT STD_LOGIC;
        ganhou : OUT STD_LOGIC;
        perdeu : OUT STD_LOGIC;
        db_rodada : OUT STD_LOGIC_VECTOR (6 DOWNTO 0);
        db_contagem : OUT STD_LOGIC_VECTOR (6 DOWNTO 0);
        db_memoria : OUT STD_LOGIC_VECTOR (6 DOWNTO 0);
        db_jogadafeita : OUT STD_LOGIC_VECTOR (6 DOWNTO 0);
        db_estado : OUT STD_LOGIC_VECTOR (6 DOWNTO 0);
        db_botoesIgualMemoria : OUT STD_LOGIC;
        db_clock : OUT STD_LOGIC;
        db_enderecoIgualRodada : OUT STD_LOGIC;
        db_tem_jogada : OUT STD_LOGIC;
        db_timeout : OUT STD_LOGIC;
        db_fim_mostra_jogada : OUT STD_LOGIC;
        db_escreveM : OUT STD_LOGIC
    );
END ENTITY;

ARCHITECTURE estrutural OF projeto_genius IS

    SIGNAL s_db_botoes : STD_LOGIC_VECTOR (5 DOWNTO 0);
    SIGNAL s_db_contagem : STD_LOGIC_VECTOR (3 DOWNTO 0);
    SIGNAL s_db_memoria : STD_LOGIC_VECTOR (5 DOWNTO 0);
    SIGNAL s_db_rodada : STD_LOGIC_VECTOR (3 DOWNTO 0);

    SIGNAL s_fimCRodada : STD_LOGIC;
    SIGNAL s_fimCEndereco : STD_LOGIC;
    SIGNAL s_enderecoIgualRodada : STD_LOGIC;
    SIGNAL s_botoesIgualMemoria : STD_LOGIC;

    SIGNAL s_jogada_correta : STD_LOGIC;
    SIGNAL s_registraR : STD_LOGIC;
    SIGNAL s_contaCEndereco : STD_LOGIC;
    SIGNAL s_contaCRodada : STD_LOGIC;

    SIGNAL s_db_estado : STD_LOGIC_VECTOR (3 DOWNTO 0);
    SIGNAL s_zeraCEndereco : STD_LOGIC;
    SIGNAL s_zeraCRodada : STD_LOGIC;
    SIGNAL s_zeraR : STD_LOGIC;

    SIGNAL s_jogada_feita : STD_LOGIC;
    SIGNAL s_tem_jogada : STD_LOGIC;
    SIGNAL s_db_jogada : STD_LOGIC_VECTOR (5 DOWNTO 0);
    SIGNAL s_conta_timeout : STD_LOGIC;

    SIGNAL s_fim_timeout : STD_LOGIC;
    SIGNAL s_reset_timeout : STD_LOGIC;
    SIGNAL s_fim_mostra_jogada : STD_LOGIC;
    SIGNAL s_reset_mostra_jogada : STD_LOGIC;

    SIGNAL s_conta_mostra_jogada : STD_LOGIC;
    SIGNAL s_escreveM : STD_LOGIC;
    SIGNAL s_modo2e3 : STD_LOGIC;
    SIGNAL s_modo1 : STD_LOGIC;

    SIGNAL s_modo : STD_LOGIC;

    s_enableControlaSelecionaTimeout : STD_LOGIC;

    COMPONENT unidade_controle IS
        PORT (
            clock : IN STD_LOGIC;
            reset : IN STD_LOGIC;
            iniciar : IN STD_LOGIC;
            igualChaveMemoria : IN STD_LOGIC;
            igualRodadaEndereco : IN STD_LOGIC;
            ultimaRodada : IN STD_LOGIC;
            jogada : IN STD_LOGIC; --joga_feita
            fim_timeout : IN STD_LOGIC;
            fim_mostra_primeira_jogada : IN STD_LOGIC;
            modo : IN STD_LOGIC_VECTOR(1 DOWNTO 0); --dois bits concatenados dos sinais de modo
            zeraCEndereco : OUT STD_LOGIC;
            zeraCRodada : OUT STD_LOGIC;
            contaCEndereco : OUT STD_LOGIC;
            contaCRodada : OUT STD_LOGIC;
            zeraR : OUT STD_LOGIC;
            registraR : OUT STD_LOGIC;
            acertou : OUT STD_LOGIC;
            errou : OUT STD_LOGIC;
            pronto : OUT STD_LOGIC;
            db_estado : OUT STD_LOGIC_VECTOR(3 DOWNTO 0);
            conta_timeout : OUT STD_LOGIC;
            reset_timeout : OUT STD_LOGIC;
            enableMostraJogada : OUT STD_LOGIC;
            zeraMostraJogada : OUT STD_LOGIC;
            escreveM : OUT STD_LOGIC;
            enableControleSelecionaTimeout : OUT STD_LOGIC;
        );
    END COMPONENT;

    COMPONENT fluxo_dados IS
        PORT (
            clock : IN STD_LOGIC;
            zeraCEndereco : IN STD_LOGIC;
            zeraCRodada : IN STD_LOGIC;
            contaCEndereco : IN STD_LOGIC;
            contaCRodada : IN STD_LOGIC;
            enableTimeout : IN STD_LOGIC;
            enableMostraJogada : IN STD_LOGIC;
            escreveM : IN STD_LOGIC;
            zeraR : IN STD_LOGIC;
            zeraTimeout : IN STD_LOGIC;
            zeraMostraJogada : IN STD_LOGIC;
            registraR : IN STD_LOGIC;
            enableControleSelecionaTimeout : IN STD_LOGIC;
            modo1 : IN STD_LOGIC;
            modo2e3 : IN STD_LOGIC;
            botoes : IN STD_LOGIC_VECTOR (5 DOWNTO 0);
            igualEnderecoJogada : OUT STD_LOGIC; --botoesIgualMemoeria
            igualEnderecoRodada : OUT STD_LOGIC; --botoesIgualMemoeria
            fimCEndereco : OUT STD_LOGIC;
            fimCRodada : OUT STD_LOGIC;
            jogada_feita : OUT STD_LOGIC; --sinal de saida do edge (obs: teoricamente o resultado deste sinal tem que ser igual ao db_tem_jogada)
            db_tem_jogada : OUT STD_LOGIC; --(edge) sinal de debub apÃ³s OR e antes de entrar no edge
            db_jogada_correta : OUT STD_LOGIC;
            db_rodada : OUT STD_LOGIC_VECTOR (3 DOWNTO 0);
            db_contagem : OUT STD_LOGIC_VECTOR (3 DOWNTO 0);
            db_memoria : OUT STD_LOGIC_VECTOR (5 DOWNTO 0);
            db_jogada : OUT STD_LOGIC_VECTOR (5 DOWNTO 0); --antigo db_botoes
            fim_timeout : OUT STD_LOGIC;
            fim_mostra_jogada : OUT STD_LOGIC;
            leds : OUT STD_LOGIC_VECTOR (5 DOWNTO 0)
        );
    END COMPONENT;

    COMPONENT hexa7seg IS
        PORT (
            hexa : IN STD_LOGIC_VECTOR(3 DOWNTO 0);
            sseg : OUT STD_LOGIC_VECTOR(6 DOWNTO 0)
        );
    END COMPONENT;
BEGIN

    UC : unidade_controle
    PORT MAP(
        clock => clock,
        reset => reset,
        iniciar => iniciar,
        igualChaveMemoria => s_botoesIgualMemoria,
        igualRodadaEndereco => s_enderecoIgualRodada,
        ultimaRodada => s_fimCRodada,
        jogada => s_jogada_feita,
        fim_timeout => s_fim_timeout,
        fim_mostra_jogada => s_fim_mostra_jogada,
        modo => s_modo,
        zeraCEndereco => s_zeraCEndereco,
        zeraCRodada => s_zeraCRodada,
        contaCEndereco => s_contaCEndereco,
        contaCRodada => s_contaCRodada,
        zeraR => s_zeraR,
        registraR => s_registraR,
        acertou => ganhou,
        errou => perdeu,
        pronto => pronto,
        db_estado => s_db_estado,
        conta_timeout => s_conta_timeout,
        reset_timeout => s_reset_timeout,
        enableMostraJogada => s_conta_mostra_jogada,
        zeraMostraJogada => s_reset_mostra_jogada,
        escreveM => s_escreveM,
        enableControlaSelecionaTimeout => s_enableControlaSelecionaTimeout
    );

    FD : fluxo_dados
    PORT MAP(
        clock => clock,
        zeraCEndereco => s_zeraCEndereco,
        zeraCRodada => s_zeraCRodada,
        contaCEndereco => s_contaCEndereco,
        contaCRodada => s_contaCRodada,
        enableTimeout => s_conta_timeout,
        enableMostraJogada => s_conta_mostra_jogada,
        escreveM => s_escreveM,
        zeraR => s_zeraR,
        zeraTimeout => s_reset_timeout,
        zeraMostraJogada => s_reset_mostra_jogada,
        registraR => s_registraR,
        enableControleSelecionaTimeout => s_enableControlaSelecionaTimeout,
        modo1 => s_modo1,
        modo2e3 => s_modo2e3,
        botoes => botoes,
        igualEnderecoJogada => s_botoesIgualMemoria,
        igualEnderecoRodada => s_enderecoIgualRodada,
        fimCEndereco => s_fimCEndereco,
        fimCRodada => s_fimCRodada,
        jogada_feita => s_jogada_feita,
        db_tem_jogada => s_tem_jogada,
        db_jogada_correta => s_jogada_correta,
        db_rodada => s_db_rodada,
        db_contagem => s_db_contagem,
        db_memoria => s_db_memoria,
        db_jogada => s_db_jogada,
        fim_timeout => s_fim_timeout,
        fim_mostra_jogada => s_fim_mostra_jogada,
        leds => leds
    );

    HEX0 : hexa7seg
    PORT MAP(
        hexa => s_db_contagem,
        sseg => db_contagem
    );

    HEX1 : hexa7seg
    PORT MAP(
        hexa => s_db_memoria(3 DOWNTO 0),
        sseg => db_memoria
    );

    HEX2 : hexa7seg
    PORT MAP(
        hexa => s_db_jogada(3 DOWNTO 0),
        sseg => db_jogadafeita
    );

    HEX3 : hexa7seg
    PORT MAP(
        hexa => s_db_estado,
        sseg => db_estado
    );

    HEX4 : hexa7seg
    PORT MAP(
        hexa => s_db_rodada,
        sseg => db_rodada
    );

    s_modo <= (modo2e3 & modo1);

    db_clock <= clock;
    db_botoesIgualMemoria <= s_botoesIgualMemoria;
    db_enderecoIgualRodada <= s_enderecoIgualRodada;
    db_timeout <= s_fim_timeout;
    db_fim_mostra_jogada <= s_fim_mostra_jogada;
    db_escreveM <= s_escreveM;

END estrutural;